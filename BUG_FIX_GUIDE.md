# Bug 修复测试指南

## 📋 修复的 Bug 列表

### Bug #1: 局域网联机模式可以一回合购买多个建筑 ✅

**问题描述**：
在局域网联机模式下，玩家可以在一个回合内购买多个建筑，违反了游戏规则（每回合只能购买一个建筑）。

**根本原因**：
- 单机模式：客户端有购买次数检查 ✅
- 联机模式：客户端只发送指令，服务器端**没有**购买次数检查 ❌

**修复内容**：
1. 在服务器端 `purchaseBuilding` 函数添加购买次数检查
2. 新增 `player.hasPurchasedThisTurn` 状态追踪每回合购买次数
3. 免费购买（祭天坛效果）不计入购买次数
4. 正确消耗 `canBuyExtra` 额外购买权限
5. `endTurn` 时重置 `hasPurchasedThisTurn` 状态

**修改的文件**：
- `server/gameEngine.js`（3 处修改）

---

### Bug #2: 从大厅断开连接后，联机页面样式错乱 ✅

**问题描述**：
从局域网大厅点击"断开连接"返回后，联机页面的样式显示异常（元素排列错乱）。

**根本原因**：
使用 `Taro.navigateBack()` 返回时，页面历史堆栈可能残留旧的 DOM 状态和事件监听器，导致页面渲染混乱。

**修复内容**：
1. 大厅断开连接时使用 `Taro.redirectTo` 替代 `Taro.navigateBack`
2. 彻底清除页面历史堆栈，避免状态残留
3. 连接页面添加状态清理日志

**修改的文件**：
- `src/pages/lan/lobby/lobby.tsx`
- `src/pages/lan/connect/connect.tsx`

---

## 🧪 测试步骤

### **测试 Bug #1 修复**

#### **测试环境准备**

1. 启动局域网服务器
   ```bash
   npm run lan:server
   ```

2. 打开两个浏览器窗口（或使用H5 + 微信开发者工具）
   ```bash
   npm run dev:h5
   ```

3. 两个客户端都连接到局域网服务器

#### **测试用例 1：正常购买限制**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 玩家A 创建房间并开始游戏 | 游戏正常开始 | ✅/❌ |
| 2 | 玩家A 投掷骰子，获得金币 | 显示金币数量 | ✅/❌ |
| 3 | 玩家A 购买第一个建筑 | 购买成功 | ✅/❌ |
| 4 | 玩家A 尝试购买第二个建筑 | 显示"每回合只能购买一个建筑" | ✅/❌ |
| 5 | 玩家A 结束回合 | 切换到玩家B | ✅/❌ |
| 6 | 下一回合玩家A 可以购买 | 购买限制重置 | ✅/❌ |

#### **测试用例 2：额外购买权限（canBuyExtra）**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 玩家拥有"珍宝阁"或其他提供额外购买的建筑 | `canBuyExtra = true` | ✅/❌ |
| 2 | 玩家购买第一个建筑 | 购买成功 | ✅/❌ |
| 3 | 玩家购买第二个建筑 | 购买成功，消耗 `canBuyExtra` | ✅/❌ |
| 4 | 玩家尝试购买第三个建筑 | 显示"每回合只能购买一个建筑" | ✅/❌ |

#### **测试用例 3：祭天坛免费购买**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 玩家拥有"祭天坛" | `canFreeBuilding = true` | ✅/❌ |
| 2 | 玩家免费购买一个建筑（非传奇）| 购买成功，不计入购买次数 | ✅/❌ |
| 3 | 玩家正常购买另一个建筑 | 购买成功 | ✅/❌ |
| 4 | 玩家尝试购买第三个建筑 | 显示"每回合只能购买一个建筑" | ✅/❌ |

#### **测试用例 4：传奇建筑购买**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 玩家拥有"祭天坛" | `canFreeBuilding = true` | ✅/❌ |
| 2 | 玩家尝试免费购买传奇建筑 | 无法免费，需要支付金币 | ✅/❌ |
| 3 | 玩家支付金币购买传奇建筑 | 购买成功，计入购买次数 | ✅/❌ |
| 4 | 玩家尝试购买第二个建筑 | 显示"每回合只能购买一个建筑" | ✅/❌ |

---

### **测试 Bug #2 修复**

#### **测试用例 1：断开连接并返回**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 进入"局域网联机"页面 | 页面正常显示 | ✅/❌ |
| 2 | 输入昵称，快速连接 | 连接成功，跳转到大厅 | ✅/❌ |
| 3 | 在大厅点击"断开连接" | 弹出确认对话框 | ✅/❌ |
| 4 | 确认断开连接 | 返回"局域网联机"页面 | ✅/❌ |
| 5 | 检查页面样式 | 样式正常，无错乱 | ✅/❌ |
| 6 | 重新连接到服务器 | 连接成功 | ✅/❌ |

#### **测试用例 2：多次连接和断开**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 连接→断开→返回 | 第1次返回，样式正常 | ✅/❌ |
| 2 | 连接→断开→返回 | 第2次返回，样式正常 | ✅/❌ |
| 3 | 连接→断开→返回 | 第3次返回，样式正常 | ✅/❌ |

#### **测试用例 3：连接失败后的页面状态**

| 步骤 | 操作 | 预期结果 | 实际结果 |
|------|------|---------|---------|
| 1 | 输入错误的服务器地址 | 连接失败，提示错误 | ✅/❌ |
| 2 | 检查页面样式 | 样式正常，无错乱 | ✅/❌ |
| 3 | 输入正确地址重新连接 | 连接成功 | ✅/❌ |

---

## 🔍 检查要点

### **服务器端日志**

启动局域网服务器后，在测试时观察终端日志：

```bash
# 正常购买
🏗️ 林克 购买建筑: basic_farm
✅ 购买成功: 农田

# 超次数购买（修复后应显示）
🏗️ 林克 购买建筑: basic_market
❌ 购买失败: 每回合只能购买一个建筑

# 额外购买权限
🏗️ 林克 购买建筑: basic_farm
✅ 购买成功: 农田（使用额外购买权限）

# 免费购买
🏗️ 林克 购买建筑: basic_house
✅ 购买成功: 民居（祭天坛免费）
```

### **客户端开发者工具**

1. 打开浏览器开发者工具（F12）
2. 切换到 Console 面板
3. 观察连接/断开时的日志：

```javascript
// 正常连接
🚀 [快速连接] 开始连接
✅ 已连接到服务器: localhost

// 断开连接（修复后）
🔄 [连接页面] 页面加载，检查连接状态
📋 [连接页面] URL参数: {}
```

---

## 📊 测试报告模板

```markdown
## Bug 修复测试报告

**测试日期**: 2026-02-14
**测试人员**: [你的名字]
**测试环境**: 
- 浏览器: Chrome 120.0.0.0
- Node.js: v22.x.x
- Taro: v3.6.38

### Bug #1: 购买次数限制

- [ ] 测试用例 1: 正常购买限制 ✅/❌
- [ ] 测试用例 2: 额外购买权限 ✅/❌
- [ ] 测试用例 3: 祭天坛免费购买 ✅/❌
- [ ] 测试用例 4: 传奇建筑购买 ✅/❌

**问题描述**: [如果有问题，描述具体情况]

**修复状态**: ✅ 通过 / ❌ 失败

---

### Bug #2: 页面样式错乱

- [ ] 测试用例 1: 断开连接并返回 ✅/❌
- [ ] 测试用例 2: 多次连接和断开 ✅/❌
- [ ] 测试用例 3: 连接失败后的页面状态 ✅/❌

**问题描述**: [如果有问题，描述具体情况]

**修复状态**: ✅ 通过 / ❌ 失败

---

### 总结

**整体修复质量**: ⭐⭐⭐⭐⭐ (1-5星)

**建议**: [任何改进建议]
```

---

## 🚀 部署步骤

### **开发环境测试**

1. 拉取最新代码
   ```bash
   git pull origin main
   ```

2. 重新安装依赖（如果需要）
   ```bash
   npm install
   ```

3. 启动局域网服务器
   ```bash
   npm run lan:server
   ```

4. 启动 H5 开发服务器
   ```bash
   npm run dev:h5
   ```

5. 按照上述测试用例进行测试

---

### **DevBox 部署**

如果需要在 DevBox 中测试：

1. 在 DevBox 终端拉取最新代码
   ```bash
   cd /home/devbox/project/TheGreatChangAn
   git pull origin main
   ```

2. 重新构建前端（清除旧缓存）
   ```bash
   rm -rf dist
   npm run build:h5
   ```

3. 重启服务
   ```bash
   bash stop-devbox.sh
   bash start-devbox.sh
   ```

4. 测试修复效果

---

### **Sealos 应用部署**

1. 在 DevBox 中发布新版本
   - 版本号: `v1.0.6`
   - 描述: `修复局域网联机两个 bug`

2. 使用新镜像更新应用
   ```
   hub.hzh.sealos.run/ns-joctqbne/changean-server:v1.0.6
   ```

3. 重新部署并测试

---

## ❓ 常见问题

### Q1: 修复后仍然可以购买多个建筑？

**可能原因**：
1. 服务器代码未更新：检查是否运行 `git pull`
2. 服务器未重启：重启 `npm run lan:server`
3. 浏览器缓存：刷新页面（Ctrl/Cmd + Shift + R）

### Q2: 页面样式仍然错乱？

**可能原因**：
1. 浏览器缓存：清除缓存并刷新
2. 代码未更新：确认前端代码已拉取最新版本
3. 构建缓存：删除 `dist/` 目录并重新构建

### Q3: 如何验证修复是否生效？

**验证方法**：
1. 查看 Git 提交历史
   ```bash
   git log --oneline -5
   ```
   应该看到：`79e5d62 修复：两个局域网联机 bug`

2. 检查服务器代码
   ```bash
   grep -n "hasPurchasedThisTurn" server/gameEngine.js
   ```
   应该看到 3 处匹配

3. 查看服务器日志
   - 购买限制生效会显示 `❌ 购买失败: 每回合只能购买一个建筑`

---

## 📝 更新日志

### v1.0.6 (2026-02-14)

**修复**：
- ✅ 修复局域网联机模式可以一回合购买多个建筑的问题
- ✅ 修复从大厅断开连接后页面样式错乱的问题

**修改的文件**：
- `server/gameEngine.js`
- `src/pages/lan/lobby/lobby.tsx`
- `src/pages/lan/connect/connect.tsx`

---

**测试愉快！** 🎮

如有问题，请查看服务器日志和浏览器控制台输出。
