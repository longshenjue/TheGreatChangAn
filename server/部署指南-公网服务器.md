# 盛世长安 - 公网服务器部署指南

## 📋 前提条件

- ✅ 云服务器（阿里云、腾讯云、AWS等）
- ✅ 公网IP地址
- ✅ 操作系统：Ubuntu 20.04 / CentOS 7 或更高版本
- ✅ 域名（可选，推荐用于HTTPS）

## 🚀 快速部署步骤

### 1. 连接到服务器

```bash
# 使用SSH连接到你的云服务器
ssh root@你的公网IP

# 例如：
ssh root@47.xxx.xxx.xxx
```

### 2. 安装Node.js

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# 验证安装
node --version  # 应该显示 v18.x.x
npm --version   # 应该显示 9.x.x
```

### 3. 上传项目文件

**方法A：使用Git（推荐）**

```bash
# 在服务器上克隆项目
cd /var/www
git clone https://github.com/你的用户名/TheGreatChangAn.git
cd TheGreatChangAn
```

**方法B：使用SCP上传**

```bash
# 在本地电脑上执行
scp -r ./server root@你的公网IP:/var/www/TheGreatChangAn/

# 例如：
scp -r ./server root@47.xxx.xxx.xxx:/var/www/TheGreatChangAn/
```

### 4. 安装依赖

```bash
cd /var/www/TheGreatChangAn/server
npm install
```

### 5. 配置防火墙

**Ubuntu (UFW)**

```bash
# 开放8888端口
sudo ufw allow 8888/tcp
sudo ufw allow 80/tcp    # HTTP（可选）
sudo ufw allow 443/tcp   # HTTPS（可选）

# 检查防火墙状态
sudo ufw status
```

**CentOS (firewalld)**

```bash
# 开放8888端口
sudo firewall-cmd --permanent --add-port=8888/tcp
sudo firewall-cmd --permanent --add-port=80/tcp    # HTTP（可选）
sudo firewall-cmd --permanent --add-port=443/tcp   # HTTPS（可选）
sudo firewall-cmd --reload

# 检查防火墙状态
sudo firewall-cmd --list-all
```

**阿里云/腾讯云安全组**

除了服务器防火墙，还需要在云服务商控制台配置安全组：

1. 登录阿里云/腾讯云控制台
2. 找到你的ECS实例
3. 配置安全组规则：
   - 协议：TCP
   - 端口：8888
   - 授权对象：0.0.0.0/0（所有IP）
   - 方向：入方向

### 6. 启动服务器

**开发模式（临时测试）**

```bash
cd /var/www/TheGreatChangAn/server
node lan-server.js
```

**生产模式（推荐使用PM2）**

```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start lan-server.js --name "changan-game"

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status

# 查看日志
pm2 logs changan-game

# 重启服务
pm2 restart changan-game

# 停止服务
pm2 stop changan-game
```

### 7. 验证部署

```bash
# 在服务器上测试
curl http://localhost:8888

# 在本地电脑上测试
# 使用浏览器或curl测试WebSocket连接
curl http://你的公网IP:8888
```

## 🔧 修改客户端连接地址

### 方法1：环境变量（推荐）

**创建配置文件**：`src/config/env.ts`

```typescript
// 开发环境：使用本地服务器
const DEV_SERVER = 'ws://localhost:8888';

// 生产环境：使用公网服务器
const PROD_SERVER = 'ws://47.xxx.xxx.xxx:8888'; // 替换为你的公网IP

export const WS_SERVER_URL = process.env.NODE_ENV === 'production' 
  ? PROD_SERVER 
  : DEV_SERVER;
```

**修改 `src/services/lanService.ts`**：

```typescript
import { WS_SERVER_URL } from '@/config/env';

class LANService {
  connect(ip: string = '', port: string = '8888'): Promise<void> {
    return new Promise((resolve, reject) => {
      // 如果是生产环境，使用预配置的服务器地址
      if (process.env.NODE_ENV === 'production') {
        this.ws = new WebSocket(WS_SERVER_URL);
      } else {
        // 开发环境：使用用户输入的地址
        const url = ip ? `ws://${ip}:${port}` : 'ws://localhost:8888';
        this.ws = new WebSocket(url);
      }
      
      // ... 其余代码不变
    });
  }
}
```

### 方法2：直接修改（简单快速）

**修改 `src/pages/lan/connect/connect.tsx`**：

```typescript
// 找到这两行（约第100-101行）
const [serverIp, setServerIp] = useState('192.168.50.109');
const [serverPort, setServerPort] = useState('8888');

// 修改为：
const [serverIp, setServerIp] = useState('47.xxx.xxx.xxx'); // 你的公网IP
const [serverPort, setServerPort] = useState('8888');
```

或者，更智能的方式：

```typescript
// 自动检测是否在本地
const getDefaultServerIp = () => {
  const hostname = window.location.hostname;
  
  // 如果是本地访问，使用localhost
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return 'localhost';
  }
  
  // 如果是局域网访问
  if (hostname.startsWith('192.168.') || hostname.startsWith('10.')) {
    return hostname;
  }
  
  // 其他情况使用公网IP
  return '47.xxx.xxx.xxx'; // 你的公网IP
};

const [serverIp, setServerIp] = useState(getDefaultServerIp());
```

## 🔒 安全建议

### 1. 使用环境变量

创建 `.env` 文件（不要提交到Git）：

```bash
# server/.env
PORT=8888
NODE_ENV=production
MAX_ROOMS=100
MAX_PLAYERS_PER_ROOM=4
```

修改 `server/lan-server.js`：

```javascript
require('dotenv').config();

const PORT = process.env.PORT || 8888;
const MAX_ROOMS = parseInt(process.env.MAX_ROOMS) || 100;
```

### 2. 限制连接数

```javascript
// server/lan-server.js
const MAX_CONNECTIONS = 100;
let currentConnections = 0;

wss.on('connection', (ws) => {
  currentConnections++;
  
  if (currentConnections > MAX_CONNECTIONS) {
    ws.send(JSON.stringify({
      type: 'error',
      message: '服务器连接数已满，请稍后再试'
    }));
    ws.close();
    return;
  }
  
  ws.on('close', () => {
    currentConnections--;
  });
  
  // ... 其余代码
});
```

### 3. 添加心跳检测（防止僵尸连接）

```javascript
// server/lan-server.js
const HEARTBEAT_INTERVAL = 30000; // 30秒

wss.on('connection', (ws) => {
  ws.isAlive = true;
  
  ws.on('pong', () => {
    ws.isAlive = true;
  });
  
  // ... 其余代码
});

// 心跳检测
setInterval(() => {
  wss.clients.forEach((ws) => {
    if (ws.isAlive === false) {
      console.log('❌ 检测到僵尸连接，断开');
      return ws.terminate();
    }
    
    ws.isAlive = false;
    ws.ping();
  });
}, HEARTBEAT_INTERVAL);
```

### 4. 使用HTTPS/WSS（生产环境强烈推荐）

**安装Nginx和SSL证书**：

```bash
# 安装Nginx
sudo apt update
sudo apt install nginx

# 安装Certbot（Let's Encrypt免费证书）
sudo apt install certbot python3-certbot-nginx

# 申请SSL证书
sudo certbot --nginx -d yourdomain.com
```

**配置Nginx反向代理**：

```nginx
# /etc/nginx/sites-available/changan-game
server {
    listen 80;
    server_name yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

    # WebSocket代理
    location /ws {
        proxy_pass http://localhost:8888;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 静态文件（可选）
    location / {
        root /var/www/TheGreatChangAn/dist;
        try_files $uri $uri/ /index.html;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/changan-game /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

客户端连接改为：

```typescript
// 使用WSS（安全WebSocket）
const url = 'wss://yourdomain.com/ws';
```

### 5. 日志管理

```javascript
// server/lan-server.js
const fs = require('fs');
const path = require('path');

const LOG_DIR = path.join(__dirname, 'logs');
if (!fs.existsSync(LOG_DIR)) {
  fs.mkdirSync(LOG_DIR);
}

function log(level, message, data) {
  const timestamp = new Date().toISOString();
  const logEntry = {
    timestamp,
    level,
    message,
    data
  };
  
  const logFile = path.join(LOG_DIR, `${new Date().toISOString().split('T')[0]}.log`);
  fs.appendFileSync(logFile, JSON.stringify(logEntry) + '\n');
  
  console.log(`[${timestamp}] ${level}: ${message}`, data || '');
}

// 使用
log('INFO', '玩家连接', { playerId, nickname });
log('ERROR', '房间不存在', { roomId });
```

## 📊 监控和维护

### 1. 使用PM2监控

```bash
# 实时监控
pm2 monit

# 查看详细信息
pm2 show changan-game

# 查看日志
pm2 logs changan-game --lines 100
```

### 2. 性能监控

```bash
# 安装PM2性能监控插件
pm2 install pm2-server-monit

# 查看性能指标
pm2 web
```

### 3. 自动重启

```bash
# 监听文件变化自动重启
pm2 start lan-server.js --watch

# 内存超限自动重启
pm2 start lan-server.js --max-memory-restart 500M

# CPU超限自动重启
pm2 start lan-server.js --max-cpu 80
```

## 🌐 域名配置（可选但推荐）

### 1. 购买域名

- 阿里云万网
- 腾讯云DNS
- GoDaddy

### 2. 配置DNS解析

| 记录类型 | 主机记录 | 记录值 |
|---------|---------|--------|
| A | @ | 你的公网IP |
| A | www | 你的公网IP |
| A | ws | 你的公网IP |

### 3. 客户端连接

```typescript
// 使用域名连接
const url = 'wss://ws.yourdomain.com';
```

## 🧪 测试部署

### 1. 本地测试连接

```bash
# 使用wscat工具测试WebSocket
npm install -g wscat

# 连接到公网服务器
wscat -c ws://你的公网IP:8888

# 连接成功后发送消息
> {"type":"register","data":{"nickname":"测试玩家"}}
```

### 2. 浏览器测试

打开浏览器控制台，执行：

```javascript
const ws = new WebSocket('ws://你的公网IP:8888');

ws.onopen = () => {
  console.log('✅ 连接成功');
  ws.send(JSON.stringify({
    type: 'register',
    data: { nickname: '测试玩家' }
  }));
};

ws.onmessage = (event) => {
  console.log('📥 收到消息:', event.data);
};

ws.onerror = (error) => {
  console.error('❌ 连接错误:', error);
};
```

### 3. 多设备测试

- 用手机连接（需要与电脑不在同一Wi-Fi）
- 用朋友的电脑连接
- 验证房间创建、加入、游戏同步等功能

## 📋 部署检查清单

- [ ] 云服务器已购买并可SSH连接
- [ ] Node.js已安装（v16+）
- [ ] 项目代码已上传到服务器
- [ ] npm依赖已安装
- [ ] 服务器防火墙已开放8888端口
- [ ] 云服务商安全组已配置
- [ ] PM2已安装并配置
- [ ] 服务已启动并运行正常
- [ ] 客户端连接地址已修改
- [ ] 本地测试连接成功
- [ ] 远程测试连接成功
- [ ] 多人联机测试通过
- [ ] 日志正常记录
- [ ] 开机自启动已配置

## 🔧 常见问题

### Q1: 连接超时/无法连接

**排查步骤**：
1. 检查服务器是否运行：`pm2 status`
2. 检查端口是否开放：`netstat -tulnp | grep 8888`
3. 检查防火墙：`sudo ufw status` 或 `sudo firewall-cmd --list-all`
4. 检查云服务商安全组配置
5. 尝试使用telnet测试：`telnet 你的公网IP 8888`

### Q2: 连接成功但游戏同步异常

**排查步骤**：
1. 查看服务器日志：`pm2 logs changan-game`
2. 检查客户端控制台是否有错误
3. 验证服务器代码版本是否最新
4. 清除客户端缓存重试

### Q3: 性能问题/卡顿

**优化建议**：
1. 升级服务器配置（增加CPU和内存）
2. 使用Nginx做反向代理和负载均衡
3. 启用GZIP压缩
4. 使用CDN加速静态资源
5. 数据库优化（如果使用）

### Q4: SSL证书配置失败

**解决方案**：
1. 确保域名已正确解析到服务器IP
2. 检查80端口是否被占用
3. 使用 `sudo certbot certonly --standalone` 手动申请
4. 查看详细错误日志：`/var/log/letsencrypt/letsencrypt.log`

## 📊 性能参考

| 服务器配置 | 预计支持玩家数 | 预计支持房间数 |
|----------|--------------|--------------|
| 1核1GB | 10-20人 | 3-5个 |
| 2核2GB | 50-100人 | 12-25个 |
| 4核4GB | 200-400人 | 50-100个 |
| 8核8GB | 1000人+ | 250个+ |

**注意**：
- 每个房间4人
- 每个WebSocket连接约占用1-2MB内存
- CPU主要用于游戏逻辑计算
- 带宽取决于消息频率

## 🎯 生产环境建议配置

```bash
# 服务器配置
CPU: 2核+
内存: 2GB+
硬盘: 20GB SSD
带宽: 3Mbps+
系统: Ubuntu 20.04 LTS

# 软件版本
Node.js: v18.x LTS
PM2: latest
Nginx: latest (如使用HTTPS)

# 安全配置
- 定期更新系统和软件
- 配置SSH密钥登录
- 禁用root直接登录
- 安装fail2ban防暴力破解
- 定期备份数据
```

## 📞 技术支持

如遇到部署问题，可以：
1. 查看服务器日志：`pm2 logs`
2. 检查错误日志：`tail -f /var/log/nginx/error.log`
3. 查看系统日志：`journalctl -xe`
4. 使用 `pm2 monit` 实时监控

---

**部署完成后，你的游戏将可以在全球任何地方访问！** 🌍
