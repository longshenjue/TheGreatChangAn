# DevBox 发布版本指南

## 📋 发布前准备

### 重要说明 ⚠️

由于 `dist/` 目录在 `.gitignore` 中被忽略，**DevBox 发布时不会包含构建产物**。

不过不用担心！`entrypoint.sh` 会在**首次启动时自动检测并构建**，所以你可以直接发布。

### 1️⃣ （可选）预先构建

如果你想在发布前测试，可以先构建：

```bash
# 安装依赖（首次或依赖变更时）
npm install

# 构建前端（可选，entrypoint.sh 会自动构建）
npm run build:h5

# 验证构建产物
ls -l dist/
```

### 2️⃣ 测试启动脚本

```bash
# 测试 entrypoint.sh 是否正常工作
./entrypoint.sh
```

**首次运行时会自动构建（需要 1-2 分钟），再次运行会跳过构建。**  
**如果启动成功，按 `Ctrl+C` 停止测试。**

---

## 🚀 发布版本

### 步骤1：打开发布界面

在 DevBox 界面点击 **"发布版本"** 按钮

### 步骤2：填写版本信息

| 字段 | 说明 | 示例 |
|------|------|------|
| **镜像名** | 自动生成，无需修改 | `hub.hzh.sealos.run/ns-xxx/changean-server` |
| **版本号** | 语义化版本号 | `v1.0.0`, `v1.1.0` |
| **版本描述** | 本次发布的更新内容 | `支持环境变量动态配置后端地址` |

### 步骤3：发布

1. 点击 **"发版"** 按钮
2. 等待发布完成（会自动提交所有更改）
3. 发布完成后 DevBox 会自动重启

---

## 🎯 应用部署

### 从 DevBox 镜像部署应用

发布成功后，你会得到一个镜像地址，例如：
```
hub.hzh.sealos.run/ns-joctqbne/changean-server:v1.0.0
```

### 在 Sealos 应用管理中部署

#### 1️⃣ 创建应用

- **镜像地址**：使用上面的镜像地址
- **CPU**：建议 0.5 Core 以上
- **内存**：建议 512 M 以上

**⚠️ 重要：高级配置**
- **启动命令**：留空（推荐）
- **运行命令**：留空（推荐）

如果必须手动指定，使用：
- **启动命令**：`/bin/bash`
- **运行命令**：`-c ./entrypoint.sh`（注意：不要写绝对路径，不要加参数）

#### 2️⃣ 配置环境变量

| 变量名 | 值 | 说明 |
|--------|-----|------|
| `PUBLIC_HOST` | `你的应用域名.sealoshzh.site` | **必填**，后端域名 |
| `PUBLIC_PROTOCOL` | `wss` | WebSocket 协议 |
| `WS_PORT` | `8888` | WebSocket 端口 |
| `HTTP_PORT` | `8889` | HTTP 健康检查端口 |

#### 3️⃣ 暴露端口

| 容器端口 | 说明 |
|----------|------|
| `8080` | 前端静态服务 |
| `8888` | 后端 WebSocket |
| `8889` | 健康检查（可选）|

#### 4️⃣ 部署

点击部署，等待应用启动。

---

## 🔍 验证部署

### 检查应用状态

```bash
# 查看应用日志
kubectl logs -f deployment/your-app-name

# 检查后端健康状态
curl http://your-app-domain:8889/status
```

### 测试连接

1. 访问前端：`https://your-app-domain.sealoshzh.site`
2. 点击 **"快速连接"** 或 **"直连模式"**
3. 输入后端域名（或留空使用默认配置）
4. 测试创建房间和加入房间

---

## ⚠️ 常见问题

### 1. 首次启动较慢（1-2 分钟）

**原因**：`dist/` 在 `.gitignore` 中，发布时不包含。首次启动需要构建。

**解决**：耐心等待，构建完成后会缓存，下次启动就很快了。

**查看构建进度**：
```bash
# 在应用日志中可以看到
📦 未找到构建产物，开始构建前端...
   这可能需要 1-2 分钟，请耐心等待...
✅ 构建完成！
```

### 2. 前端显示的是旧的后端配置

**现象**：前端页面"高级选项"中显示的 IP 地址是旧域名，不是新设置的环境变量。

**原因**：前端配置在构建时注入，dist 目录缓存了旧配置。

**解决方案**：

**方案1：自动检测（推荐）**
- 重启应用，`entrypoint.sh` 会自动检测配置变化并重新构建

**方案2：强制重建**
- 在环境变量中添加 `FORCE_REBUILD=true`
- 重启应用
- 构建完成后可以删除这个环境变量

**方案3：手动删除**
- 进入容器终端：`rm -rf /app/dist`
- 重启应用

### 3. 启动时报错：找不到 package.json

**错误信息**：
```
npm error path /home/devbox/project/package.json
npm error enoent Could not read package.json
```

**原因**：工作目录不正确，或启动命令配置错误。

**解决**：
1. **方案1（推荐）**：启动命令和运行命令都留空
2. **方案2**：使用相对路径 `./entrypoint.sh`，不要用绝对路径
3. 检查 entrypoint.sh 是否有 `cd` 到正确目录的代码

### 3. 应用启动后无法连接后端

**检查**：
- 环境变量 `PUBLIC_HOST` 是否正确设置
- 后端域名是否可访问（不是前端域名）
- 防火墙是否开放 8888 端口

### 4. 前端页面显示但后端无响应

**检查后端日志**：
```bash
# 在应用容器中
ps aux | grep node
```

**查看后端是否启动**：
```bash
curl http://localhost:8889/status
```

---

## 📚 相关文档

- [Sealos 应用启动配置](https://sealos.run/docs/guides/fundamentals/entrypoint-sh)
- [Sealos 环境变量配置](https://sealos.run/docs/guides/app-management/environment-variables)
- [项目部署指南](./DEPLOYMENT.md)

---

## 📋 部署配置检查清单

在部署前，确认以下配置都正确：

### ✅ 基础配置
- [ ] 镜像地址正确（`hub.hzh.sealos.run/ns-xxx/changean-server:v1.x.x`）
- [ ] CPU ≥ 0.5 Core
- [ ] 内存 ≥ 512 M

### ✅ 网络配置
- [ ] 暴露端口 8080（前端）
- [ ] 暴露端口 8888（后端 WebSocket）
- [ ] 记下 8888 端口对应的域名（例如：`uzmebucelwbk.sealoshzh.site`）

### ✅ 高级配置
- [ ] **启动命令**：留空（推荐）
- [ ] **运行命令**：留空（推荐）
- [ ] **不要使用绝对路径**（如 `/home/devbox/project/entrypoint.sh`）
- [ ] **不要添加额外参数**（如 `prod`）

### ✅ 环境变量
- [ ] `PUBLIC_HOST` = 8888 端口的域名（重要！）
- [ ] `PUBLIC_PROTOCOL` = `wss`
- [ ] `WS_PORT` = `8888`
- [ ] `HTTP_PORT` = `8889`
- [ ] `NODE_ENV` = `production`

### ✅ 验证步骤
1. 部署后等待 1-2 分钟（首次构建）
2. 查看应用日志，确认看到 "✅ 构建完成！"
3. 访问前端域名（8080 端口）
4. 测试快速连接或直连模式

---

## 🎉 最佳实践

1. **版本号规范**：
   - 主版本号：重大功能更新或架构变更
   - 次版本号：新功能添加
   - 修订号：Bug 修复

   示例：`v1.2.3`

2. **发布前检查**：
   - ✅ 代码已构建（`npm run build:h5`）
   - ✅ 本地测试通过
   - ✅ `entrypoint.sh` 可执行
   - ✅ 环境变量已配置

3. **发布描述**：
   ```
   v1.0.0 - 初始发布
   v1.1.0 - 支持环境变量动态配置
   v1.1.1 - 修复连接超时问题
   ```

---

**更新时间**：2026-02-14
