# 局域网模式快速测试指南

## 🎯 测试目标

验证局域网联机模式的所有游戏逻辑与单机模式一致，特别是已修复的 bug 和特殊建筑效果。

---

## 🚀 测试环境准备

### 1. 启动服务器
```bash
cd /Users/longshenjue/Documents/AI-project/TheGreatChangAn
npm run lan:server
```

### 2. 启动前端（打开2-3个窗口）
```bash
npm run dev:h5
```

### 3. 连接到服务器
- 在每个浏览器窗口中输入昵称（玩家A、玩家B、玩家C）
- 点击"开始游戏"连接到 `localhost:8888`

### 4. 创建房间
- 玩家A 创建房间
- 玩家B、玩家C 加入房间
- 点击"开始游戏"

---

## ✅ 核心功能测试（15分钟）

### Test #1: 购买次数限制 ⭐ **重要**

**目的**：验证 Bug #1 修复

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 投骰子，获得足够金币 | 显示金币 | ☐ |
| 2 | 玩家A 购买第1个建筑 | 购买成功 | ☐ |
| 3 | 玩家A 尝试购买第2个建筑 | **拒绝**："每回合只能购买一个建筑" | ☐ |
| 4 | 玩家A 结束回合 | 切换到玩家B | ☐ |
| 5 | 下一回合玩家A 购买建筑 | 购买成功（限制已重置）| ☐ |

**服务器日志**（应该看到）：
```
🏗️ 玩家A 购买建筑: basic_farm
✅ 购买成功: 农田

🏗️ 玩家A 购买建筑: basic_market
❌ 购买失败: 每回合只能购买一个建筑
```

---

### Test #2: 额外购买权限（珍宝阁）

**目的**：验证 `canBuyExtra` 逻辑

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 投掷出7或8点 | 触发珍宝阁（如果拥有）| ☐ |
| 2 | 玩家A 购买第1个建筑 | 购买成功 | ☐ |
| 3 | 玩家A 购买第2个建筑 | **购买成功**（使用额外权限）| ☐ |
| 4 | 玩家A 尝试购买第3个建筑 | **拒绝**："每回合只能购买一个建筑" | ☐ |

**检查点**：
- ✅ 珍宝阁触发后，`canBuyExtra = true`
- ✅ 使用额外权限后，`canBuyExtra = false`

---

### Test #3: 祭天坛免费购买

**目的**：验证免费购买不计入次数

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 投掷出11或12点 | 触发祭天坛（如果拥有）| ☐ |
| 2 | 玩家A 免费购买1个建筑 | **购买成功，不花费金币** | ☐ |
| 3 | 玩家A 正常购买另1个建筑 | **购买成功**（免费不计次数）| ☐ |
| 4 | 玩家A 尝试购买第3个建筑 | **拒绝**："每回合只能购买一个建筑" | ☐ |

**检查点**：
- ✅ 祭天坛只能免费购买非传奇建筑
- ✅ 免费购买不消耗 `hasPurchasedThisTurn`

---

### Test #4: 火系结算（红袖招、金光罩、大运河）

**目的**：验证火系特殊规则

#### 4.1 红袖招限制

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家B 拥有红袖招 | - | ☐ |
| 2 | 玩家A 投掷出3点 | 触发红袖招 | ☐ |
| 3 | 玩家A 向玩家B 支付 | **最多2金**（不是红袖招的3金）| ☐ |

#### 4.2 金光罩减半

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有金光罩（矿冶所）| - | ☐ |
| 2 | 玩家B 拥有火系建筑收益3金 | - | ☐ |
| 3 | 玩家A 投掷触发该建筑 | 支付 **2金**（3÷2向上取整）| ☐ |

#### 4.3 大运河免疫

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有大运河 | - | ☐ |
| 2 | 玩家A 投掷触发火系建筑 | **免疫损失**（第1次）| ☐ |
| 3 | 玩家A 再次触发火系 | **正常支付**（只免疫1次）| ☐ |
| 4 | 玩家A 结束回合，下一回合触发 | **免疫损失**（限制重置）| ☐ |

---

### Test #5: 水系建筑（全员收益）

**目的**：验证多人结算

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A、B、C 都拥有渔梁 | - | ☐ |
| 2 | 玩家A 投掷出1点 | **所有人** 获得1金 | ☐ |
| 3 | 检查玩家B、C的金币 | 金币增加 | ☐ |

**检查点**：
- ✅ 水系建筑由**所有拥有者**收益
- ✅ 不仅是当前玩家

---

### Test #6: 观星台双骰子

**目的**：验证观星台效果

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 购买观星台 | 购买成功 | ☐ |
| 2 | 玩家A 投掷骰子 | **投掷2个骰子** | ☐ |
| 3 | 玩家A 结算后 | 获得 **+1金**（观星收益）| ☐ |
| 4 | 如果投出对子（如3+3）| 点数合计为6（不是倍数）| ☐ |

**注意**：对子倍率只在**乾坤变色模式 + 天气触发**时生效

---

### Test #7: 天策府翻转骰子

**目的**：验证翻转逻辑

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有天策府 | - | ☐ |
| 2 | 玩家A 投掷出1点 | 显示"翻转骰子"按钮 | ☐ |
| 3 | 玩家A 点击翻转 | 骰子变为 **6点**（7-1）| ☐ |
| 4 | 重新结算 | 按6点结算 | ☐ |

**翻转规则**：
- 1 ↔ 6
- 2 ↔ 5
- 3 ↔ 4

---

### Test #8: 乐游原登高远望

**目的**：验证复杂计算

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有乐游原 | - | ☐ |
| 2 | 玩家B 有10个建筑（全场最多）| - | ☐ |
| 3 | 玩家A 投掷出≥7点 | 触发登高远望 | ☐ |
| 4 | 玩家A 获得金币 | **6金**（10-4）| ☐ |

**公式**：`收益 = max(其他玩家建筑数) - 4`

---

### Test #9: 万国来朝固定收益

**目的**：验证每回合固定收益

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有万国来朝 | - | ☐ |
| 2 | 玩家A 投掷骰子（任意点数）| 结算后获得 **+10金** | ☐ |
| 3 | 连续3回合投掷 | 每次都获得10金 | ☐ |

---

### Test #10: 大雁塔/昆明池共鸣

**目的**：验证元素共鸣

#### 大雁塔（金系共鸣）

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有大雁塔 | - | ☐ |
| 2 | 玩家A 有5个金系建筑 | - | ☐ |
| 3 | 玩家A 投掷骰子 | 结算后获得 **+5金** | ☐ |

#### 昆明池（水系共鸣）

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有昆明池 | - | ☐ |
| 2 | 玩家A 有4个水系建筑 | - | ☐ |
| 3 | 玩家A 投掷骰子 | 结算后获得 **+4金** | ☐ |

---

### Test #11: 兵马俑减税卡

**目的**：验证减税卡机制

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 投掷出9或10点 | 触发兵马俑（如果拥有）| ☐ |
| 2 | 玩家A 获得减税卡 | **+2张减税卡** | ☐ |
| 3 | 玩家A 购买10金建筑 | 可使用减税卡抵扣 | ☐ |
| 4 | 实际支付 | **8金**（10-2）| ☐ |

---

### Test #12: 金库国库金

**目的**：验证国库机制

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 全场购买5次建筑 | 国库积累 **5金** | ☐ |
| 2 | 玩家A 投掷出11或12点 | 触发金库（如果拥有）| ☐ |
| 3 | 玩家A 获得国库金 | **+10金**（5x2）| ☐ |
| 4 | 国库清空 | 国库变为0金 | ☐ |

**国库税金规则**：
- 每次购买建筑（包括升级），国库+1金
- 金库收益 = 国库金 x 2

---

### Test #13: 升级建筑差价

**目的**：验证升级逻辑

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 拥有农田（成本2金）| - | ☐ |
| 2 | 玩家A 升级为百果园（成本4金）| - | ☐ |
| 3 | 实际支付 | **2金**（4-2差价）| ☐ |
| 4 | 农田消失 | 农田返回牌库 | ☐ |
| 5 | 百果园添加 | 玩家A 获得百果园 | ☐ |

---

### Test #14: 胜利条件

**目的**：验证游戏结束

| 步骤 | 操作 | 预期结果 | 通过？ |
|------|------|---------|--------|
| 1 | 玩家A 金币+建筑总价值 ≥ 100金 | - | ☐ |
| 2 | 购买建筑达标 | 游戏立即结束 | ☐ |
| 3 | 显示胜利画面 | 玩家A 胜利 | ☐ |
| 4 | 其他玩家看到 | 同样的胜利画面 | ☐ |

---

## 🐛 Bug验证测试

### Bug #1: 购买次数限制（已修复）

**复现步骤**（修复前）：
1. 玩家A 获得足够金币
2. 玩家A 连续购买2个建筑
3. **Bug**: 两次都成功（应该拒绝第2次）

**验证修复**：
```bash
# 服务器日志应该显示：
❌ 购买失败: 每回合只能购买一个建筑
```

✅ **通过？** ☐

---

### Bug #2: 页面样式错乱（已修复）

**复现步骤**（修复前）：
1. 连接到服务器，进入大厅
2. 点击"断开连接"
3. **Bug**: 返回后页面样式错乱

**验证修复**：
1. 连接→断开→返回
2. 检查页面样式
3. ✅ 样式正常，无错乱

✅ **通过？** ☐

---

## 📊 测试结果记录

### 测试摘要

**测试日期**: ____________________

**测试人员**: ____________________

**测试环境**:
- Node.js: v______
- 浏览器: ______
- 玩家数量: ______

### 通过率

| 类别 | 通过 | 总数 | 通过率 |
|------|------|------|--------|
| 核心功能 | __/14 | 14 | __% |
| Bug 验证 | __/2 | 2 | __% |
| **总计** | **__/16** | **16** | **__%** |

### 发现的问题

| # | 问题描述 | 严重程度 | 复现步骤 |
|---|---------|---------|---------|
| 1 | | ⚠️ 高/中/低 | |
| 2 | | ⚠️ 高/中/低 | |
| 3 | | ⚠️ 高/中/低 | |

### 测试结论

- [ ] ✅ 所有测试通过，可以发布
- [ ] ⚠️ 部分测试失败，需要修复
- [ ] ❌ 重大问题，暂停发布

**备注**: ___________________________________________________________________

---

## 🎮 测试技巧

### 快速设置金币

如果需要测试购买建筑，可以：
1. 在服务器代码中临时修改初始金币
2. 或者投掷多次骰子积累金币
3. 或者使用万国来朝快速获得金币

### 查看服务器日志

测试时保持终端可见，观察日志输出：
```bash
npm run lan:server

# 应该看到详细的日志：
🎲 [投骰子] 开始处理
✅ 购买成功: 农田
❌ 购买失败: 每回合只能购买一个建筑
```

### 浏览器开发者工具

按 F12 打开控制台，查看前端日志：
```javascript
📤 发送购买建筑指令到服务器: basic_farm
✅ 购买成功
```

---

## ⏱️ 预计测试时间

- **核心功能测试（Test #1-14）**: 约 15-20 分钟
- **Bug 验证（Bug #1-2）**: 约 5 分钟
- **总计**: 约 20-25 分钟

---

## 📝 测试报告模板

```markdown
# 局域网模式测试报告

**测试日期**: 2026-02-14
**测试版本**: v1.0.6
**测试人员**: [你的名字]

## 测试结果

### 通过的测试
- ✅ Test #1: 购买次数限制
- ✅ Test #2: 额外购买权限
- ...

### 失败的测试
- ❌ Test #X: [测试名称]
  - **问题**: [描述问题]
  - **预期**: [预期结果]
  - **实际**: [实际结果]
  - **严重程度**: 高/中/低

## 总体评价

**游戏逻辑一致性**: ⭐⭐⭐⭐⭐ (5/5)
**稳定性**: ⭐⭐⭐⭐⭐ (5/5)
**性能**: ⭐⭐⭐⭐★ (4/5)

## 建议

1. [建议1]
2. [建议2]
3. [建议3]

## 结论

- [ ] ✅ 通过测试，建议发布
- [ ] ⚠️ 存在问题，需要修复后再测试
- [ ] ❌ 重大问题，暂停发布
```

---

**祝测试愉快！** 🎮

如有问题，请查看：
- `GAME_LOGIC_AUDIT.md` - 完整的逻辑审查报告
- `BUG_FIX_GUIDE.md` - Bug 修复详细说明
- 服务器日志 - 实时的游戏逻辑执行情况
